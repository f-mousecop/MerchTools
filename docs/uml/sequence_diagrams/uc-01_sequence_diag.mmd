---

---

sequenceDiagram
title UC-01 Scan SKU
actor User
participant UI as ScanScreen (UI)
participant VM as ScanViewModel
participant Perm as PermissionManager
participant Cam as BarcodeScanner (Camera)
participant Repo as SkuRepository
participant Nav as AppNav

User->>UI: Tap "Scan"
UI->>VM: startScan()

VM->>Perm: hasCameraPermission()
alt Permission granted
    VM->>Cam: openAndStartStream()
    Cam-->>VM: onBarcodeDecoded(upc)
    VM->>Repo: findByUpc(upc)
    Repo-->>VM: matches: List<Sku>
    alt Exactly one match
        VM->>Nav: goToCapture(skuId)
        Nav-->>UI: Navigate to Capture
    else Multiple matches
        VM-->>UI: showDisambiguation(matches)
        User->>UI: Select SKU
        UI->>VM: onSkuChosen(skuId)
        VM->>Nav: goToCapture(skuId)
    else No match
        VM-->>UI: showNoMatch(upc)
        UI->>VM: openSearchWithPrefill(upc)
    end
    VM->>Cam: stopStream()
else Permission not granted
    VM-->>UI: showPermissionRationale()
    User->>UI: Accept permission request
    UI->>Perm: requestCameraPermission()
    Perm-->>VM: onPermissionResult(granted/denied)
    alt Granted on retry
        VM->>Cam: openAndStartStream()
        Cam-->>VM: onBarcodeDecoded(upc)
        VM->>Repo: findByUpc(upc)
        Repo-->>VM: matches
        VM->>Nav: navigate according to results
        VM->>Cam: stopStream()
    else Denied
        VM-->>UI: showManualSearchFallback()
    end
end

note over VM,Repo: Errors (decode/IO) â†’ showRetry() or fallback to Search
